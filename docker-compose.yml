services:
  backend:
    build:
      context: ./backend
    container_name: rf-console-backend
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - PORT=8080
      - DATA_DIR=/data
      - STREAM_URL=http://localhost:8000/stream
      - ICECAST_STATUS_URL=http://icecast:8000/status-json.xsl
      - ADMIN_TOKEN=${ADMIN_TOKEN:-}
      - CONTROL_PRIVATE_ONLY=${CONTROL_PRIVATE_ONLY:-1}
      - HOST_HELPER_URL=${HOST_HELPER_URL:-http://host.docker.internal:9911}
      - HOST_HELPER_TOKEN=${HOST_HELPER_TOKEN:-}
      - OP25_CONTAINER=rf-console-op25
      - ICECAST_CONTAINER=rf-console-icecast
      - STREAMER_CONTAINER=rf-console-streamer
      - BACKEND_CONTAINER=rf-console-backend
    volumes:
      - ./data:/data
      - /var/run/docker.sock:/var/run/docker.sock
    extra_hosts:
      - "host.docker.internal:host-gateway"

  icecast:
    image: moul/icecast
    container_name: rf-console-icecast
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - ./icecast/icecast.xml:/etc/icecast2/icecast.xml:ro

  op25:
    build:
      context: ./op25/docker
    image: rf-console-op25:local
    container_name: rf-console-op25
    restart: unless-stopped
    depends_on:
      - icecast
    devices:
      - /dev/bus/usb:/dev/bus/usb
    environment:
      - OP25_ACTIVE_PROFILE_FILE=/runtime/active-profile.json
      - OP25_PROFILES_DIR=/config
      - OP25_AUDIO_OUT=plughw:Loopback,0,0
    volumes:
      - ./data/profiles:/config:ro
      - ./data/runtime:/runtime

  # OP25 audio path: OP25 -> ALSA loopback -> streamer (ffmpeg) -> Icecast
  streamer:
    build:
      context: ./streamer
    container_name: rf-console-streamer
    restart: unless-stopped
    depends_on:
      - icecast
    devices:
      - /dev/snd:/dev/snd
    environment:
      - ALSA_DEVICE=hw:Loopback,1,0
      - ICECAST_URL=icecast://source:sourcepass@icecast:8000/stream
      - AUDIO_BITRATE=32k
      - AUDIO_SAMPLE_RATE=22050
      - AUDIO_CHANNELS=1
